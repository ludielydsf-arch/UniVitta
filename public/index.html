<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Clínica Médica</title>
  <style>
:root{--bg:#0b1020;--bg-2:#0d1324;--card:#121a2b;--muted:#7a89a7;--text:#e7ecf7;--primary:#7dd3fc;--primary-2:#60a5fa;--accent:#1f2a44;--accent-2:#182237;--danger:#ef4444;--danger-2:#b91c1c;--border:#23314c;--success:#10b981}
[data-theme="light"]{--bg:#f6f7fb;--bg-2:#f1f3f9;--card:#ffffff;--muted:#51607b;--text:#0f172a;--primary:#2563eb;--primary-2:#1d4ed8;--accent:#f3f4f6;--accent-2:#e5e7eb;--danger:#ef4444;--danger-2:#b91c1c;--border:#e5e7eb;--success:#10b981}
*{box-sizing:border-box}
body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;margin:0;background:linear-gradient(180deg,var(--bg) 0%,var(--bg-2) 100%);color:var(--text)}
.app{display:grid;grid-template-columns:260px 1fr;gap:16px;max-width:1400px;margin:0 auto;padding:20px}
.sidebar{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:16px;height:calc(100vh - 40px);position:sticky;top:20px}
.brand{display:flex;align-items:center;gap:10px;margin-bottom:14px}
.logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--primary-2))}
.theme-toggle{margin-left:auto;padding:8px 12px;border-radius:10px;background:var(--accent);color:var(--text);border:1px solid var(--border)}
.nav{display:flex;flex-direction:column;gap:8px}
.nav a{padding:10px 12px;border-radius:10px;text-decoration:none;color:var(--text);background:var(--accent);border:1px solid var(--border)}
.nav a:hover{background:var(--accent-2)}
.logout{margin-top:auto}
.content{display:flex;flex-direction:column;gap:16px;padding:0 4px}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:24px}
h1{margin:0 0 8px;font-size:26px}
h2{margin:0 0 12px;font-size:20px;color:var(--muted)}
.field{margin-bottom:12px}
.field label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
.field input,.field textarea,.field select{width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:12px;background:var(--accent);color:var(--text);outline:none}
.field input:focus,.field textarea:focus,.field select:focus{border-color:var(--primary)}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
@media (max-width:980px){.app{grid-template-columns:1fr}.sidebar{height:auto;position:static}.grid{grid-template-columns:1fr}}
button{padding:10px 14px;border:0;border-radius:12px;background:linear-gradient(90deg,var(--primary) 0%,var(--primary-2) 100%);color:#fff;cursor:pointer;transition:.2s transform,.2s filter}
button:hover{transform:translateY(-1px);filter:brightness(1.05)}
.secondary{background:var(--accent);color:var(--text);border:1px solid var(--border)}
.danger{background:var(--danger)}
.danger:hover{background:var(--danger-2)}
table{width:100%;border-collapse:separate;border-spacing:0 8px;margin-top:12px}
thead th{font-size:12px;color:var(--muted)}
tbody tr{background:var(--accent);border:1px solid var(--border)}
th,td{padding:12px 14px;text-align:left}
.hidden{display:none}
.small{font-size:12px;color:var(--muted)}
.calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
.calendar-cell{background:var(--accent);border:1px solid var(--border);border-radius:12px;padding:8px}
.calendar-date{font-size:12px;color:var(--muted);margin-bottom:6px}
.toast{position:fixed;right:20px;bottom:20px;background:var(--card);border:1px solid var(--border);color:var(--text);padding:12px 14px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.25);z-index:999}
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo"></div>
        <div style="font-weight:600">UniVitta</div>
        <button class="theme-toggle" id="theme-toggle">Tema</button>
      </div>
      <nav class="nav" id="main-nav" style="display:none">
        <a class="secondary" data-route="#dashboard">Dashboard</a>
        <a class="secondary" data-route="#cadastros">Pacientes/Médicos</a>
        <a class="secondary" data-route="#plano">Plano Univitta</a>
        <a class="secondary" data-route="#agendamento">Agendamento</a>
        <a class="secondary" data-route="#financeiro">Financeiro</a>
        <a class="secondary" data-route="#relatorios">Relatórios</a>
        <button class="danger logout" id="logout">Sair</button>
      </nav>
    </aside>
    <main class="content">

    <section id="section-login" class="card">
      <h2>Login da Equipe</h2>
      <form id="login-form">
        <div class="field"><label>Email</label><input type="email" name="email" required placeholder="seu@email.com"></div>
        <div class="field"><label>Senha</label><input type="password" name="senha" required placeholder="••••••••"></div>
        <button class="primary" type="submit" style="width:100%">Entrar no Sistema</button>
      </form>
      <p class="small" style="text-align:center;margin-top:16px">Não possui acesso? <a id="link-cadastro" href="#cadastro">Solicite aqui</a></p>
      <div id="msg"></div>
    </section>

    <section id="section-cadastro" class="card hidden">
      <h2>Cadastro de Administrador</h2>
      <form id="signup-form">
        <div class="grid">
          <div class="field"><label>Nome</label><input name="nome" required></div>
          <div class="field"><label>Sobrenome</label><input name="sobrenome" required></div>
        </div>
        <div class="field"><label>Email Profissional</label><input type="email" name="email" required></div>
        <div class="field"><label>Senha de Acesso</label><input type="password" name="senha" required></div>
        <button class="primary" type="submit" style="width:100%">Finalizar Cadastro</button>
      </form>
      <p class="small" style="text-align:center;margin-top:16px"><a href="#login">Voltar para o Login</a></p>
      <div id="msg-cadastro"></div>
    </section>

    <section id="section-dashboard" class="hidden">
      <div class="grid" id="dash-kpis" style="grid-template-columns: repeat(4, 1fr);">
        <!-- KPIs via JS -->
      </div>
      <div class="grid" style="grid-template-columns: 2fr 1fr; margin-top: 16px;">
        <div class="card">
          <h2>Desempenho Mensal</h2>
          <canvas id="dash-chart" width="600" height="250" style="width:100%;height:250px"></canvas>
        </div>
        <div class="card">
          <h2>Próximas Consultas</h2>
          <table id="dash-upcoming" class="small">
            <thead><tr><th>Data</th><th>Hora</th><th>Especialidade</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="section-cadastros" class="hidden">
      <div class="card">
        <h2>Gestão de Pacientes</h2>
        <form id="paciente-form">
          <input type="hidden" name="id">
          <div class="grid">
            <div class="field"><label>Nome</label><input name="nome" required></div>
            <div class="field"><label>Sobrenome</label><input name="sobrenome" required></div>
            <div class="field"><label>Data de Nascimento</label><input type="date" name="dataNascimento" required></div>
            <div class="field"><label>Email</label><input type="email" name="email" required></div>
            <div class="field"><label>Data de Adesão do Plano</label><input type="date" name="dataAdesaoPlano" required></div>
            <div class="field"><label>Endereço</label><input name="endereco" required></div>
            <div class="field"><label>Telefone</label><input name="telefone" required></div>
            <div class="field"><label>Documento (CPF/RG)</label><input name="documento" required></div>
            <div class="field"><label>Nº da Carteira Univitta</label><input name="numeroCarteira"></div>
            <div class="field">
              <label>Tempo Contratado (Plano)</label>
              <select name="planoMeses">
                <option value="">Selecione</option>
                <option value="3">3 meses</option>
                <option value="6">6 meses</option>
              </select>
            </div>
          </div>
          <div class="row">
            <button class="primary" type="submit">Salvar Paciente</button>
            <button class="secondary" type="button" id="reset-paciente">Limpar / Novo</button>
          </div>
        </form>
        <div style="overflow-x:auto">
          <table id="pacientes-table"><thead><tr><th>Nome</th><th>Email</th><th>Telefone</th><th>Documento</th><th>Carteira</th><th>Plano</th><th>Ações</th></tr></thead><tbody></tbody></table>
        </div>
      </div>

      <div class="card" style="margin-top:16px">
        <h2>Gestão de Médicos</h2>
        <form id="medico-form">
          <input type="hidden" name="id">
          <div class="grid">
            <div class="field"><label>Nome</label><input name="nome" required></div>
            <div class="field"><label>Sobrenome</label><input name="sobrenome" required></div>
            <div class="field"><label>Email</label><input type="email" name="email" required></div>
            <div class="field"><label>Telefone</label><input name="telefone" required></div>
            <div class="field"><label>Documento</label><input name="documento" required></div>
            <div class="field"><label>Especialidade</label><input name="especialidade" required></div>
          </div>
          <div class="row">
            <button class="primary" type="submit">Salvar Médico</button>
            <button class="secondary" type="button" id="reset-medico">Limpar / Novo</button>
          </div>
        </form>
        <div style="overflow-x:auto">
          <table id="medicos-table"><thead><tr><th>Nome</th><th>Email</th><th>Telefone</th><th>Documento</th><th>Especialidade</th><th>Ações</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
      <div id="msg-dashboard"></div>
    </section>

    <section id="section-plano" class="hidden">
      <div class="card">
        <div class="brand" style="margin-bottom:20px">
          <div class="logo" style="background:linear-gradient(135deg, #10b981, #059669)"></div>
          <h2>Painel Plano Univitta</h2>
        </div>
        <div style="overflow-x:auto">
          <table id="plano-table">
            <thead><tr><th>Paciente Completo</th><th>Documento</th><th>Data Adesão</th><th>Tempo Contratado</th><th>Dia Vencimento</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="section-agendamento" class="hidden">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h2>Agenda Clínica</h2>
          <div class="row">
            <select id="calendar-view">
              <option value="mensal">Mensal</option>
              <option value="semanal">Semanal</option>
              <option value="diaria">Diária</option>
            </select>
            <input type="date" id="calendar-date">
            <button class="secondary" id="prev">Anterior</button>
            <button class="secondary" id="next">Próximo</button>
            <button class="primary" id="novo-agendamento">+ Novo Agendamento</button>
          </div>
        </div>
      </div>
      <div id="calendar" style="margin-top:16px"></div>
      
      <div id="modal" class="card hidden" style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1000;width:90%;max-width:600px;box-shadow:0 0 50px rgba(0,0,0,0.5)">
        <h2>Agendar Consulta</h2>
        <form id="agendamento-form">
          <div class="grid">
            <div class="field"><label>Paciente</label><select name="paciente_id" id="sel-paciente" required></select></div>
            <div class="field"><label>Médico</label><select name="medico_id" id="sel-medico" required></select></div>
            <div class="field"><label>Especialidade</label><input name="especialidade" required></div>
            <div class="field"><label>Sala</label><input name="sala"></div>
            <div class="field"><label>Data</label><input type="date" name="data" required></div>
            <div class="field"><label>Hora</label><input type="time" name="hora" required></div>
            <div class="field"><label>Duração (min)</label><input type="number" name="duracao" value="30" required></div>
          </div>
          <div class="row" style="margin-top:20px">
            <button class="primary" type="submit">Confirmar Agendamento</button>
            <button class="secondary" type="button" id="cancel-agendamento">Fechar</button>
          </div>
        </form>
        <div id="msg-agendamento"></div>
      </div>
    </section>

    <section id="section-financeiro" class="hidden">
      <div class="card">
        <h2>Controle Financeiro</h2>
        <form id="pagamento-form">
          <div class="grid">
            <div class="field"><label>Consulta / Paciente</label><input name="consulta_id" required placeholder="ID ou Nome"></div>
            <div class="field"><label>Método / Convênio</label><input name="convenio" placeholder="Ex: Particular, Unimed..."></div>
            <div class="field"><label>Procedimento</label><input name="procedimento" placeholder="Ex: Consulta Geral"></div>
            <div class="field"><label>Valor (R$)</label><input type="number" step="0.01" name="valor" required></div>
          </div>
          <div class="row"><button class="primary" type="submit">Registrar Recebimento</button></div>
        </form>
        <div id="msg-financeiro"></div>
        <div style="overflow-x:auto; margin-top:20px">
          <table id="pagamentos-table"><thead><tr><th>Descrição</th><th>Método</th><th>Procedimento</th><th>Valor</th><th>Data</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </section>

    <section id="section-relatorios" class="hidden">
      <div class="card">
        <h2>Relatórios e Exportação</h2>
        <div id="kpis-rel" class="grid" style="margin-bottom:20px"></div>
        <div class="row">
          <button class="primary" id="export-csv">Baixar Relatório Financeiro (CSV)</button>
        </div>
        <div id="msg-relatorios"></div>
      </div>
    </section>

 
    </main>
  </div>

  <script type="module">
    const { createClient } = await import("https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/+esm")
    const supabase = createClient("https://xpyqwttguspnlwekgsve.supabase.co", "sb_publishable_VpuyIhNM4oK5kmm1WdhDBQ_0d8NioX0")
    
    const nav = document.getElementById("main-nav")
    const logoutBtn = document.getElementById("logout")
    const msgDash = document.getElementById("msg-dashboard")
    const dashKpis = document.getElementById("dash-kpis")
    const dashChart = document.getElementById("dash-chart")
    const dashUpcomingBody = document.querySelector("#dash-upcoming tbody")
    const pacienteForm = document.getElementById("paciente-form")
    const medicoForm = document.getElementById("medico-form")

    // Navigation logic
    function show(id){ 
      document.querySelectorAll("section").forEach(s=>s.classList.add("hidden")); 
      const target = document.getElementById(id);
      if(target) target.classList.remove("hidden");
    }

    function routeTo(hash){ 
      location.hash = hash; 
      renderRoute(); 
    }

    async function renderRoute(){
      const p = (location.hash || "#dashboard").replace("#","")
      const { data: { session } } = await supabase.auth.getSession();

      if(!session && p !== "cadastro" && p !== "login"){
        show("section-login");
        nav.style.display = "none";
        return;
      }

      if(session) nav.style.display = "flex";

      if(p==="dashboard") { show("section-dashboard"); loadDash(); }
      else if(p==="cadastros") { show("section-cadastros"); initCadastros(); }
      else if(p==="plano") { show("section-plano"); fetchPacientes().then(renderPlanoUnivitta); }
      else if(p==="agendamento") { show("section-agendamento"); refreshCal(); updateSelectors(); }
      else if(p==="financeiro") { show("section-financeiro"); loadPay().then(renderPay); }
      else if(p==="relatorios") { show("section-relatorios"); loadKPIs(); }
      else if(p==="cadastro") show("section-cadastro")
      else if(p==="login") show("section-login")
      else { show("section-dashboard"); loadDash(); }
    }

    // Auth Helpers
    async function updateNav(){ 
      const { data: { session } } = await supabase.auth.getSession(); 
      if(session){
        nav.style.display = "flex"; 
        document.getElementById("section-login").classList.add("hidden");
      } else {
        nav.style.display = "none";
        if(location.hash !== "#cadastro") show("section-login");
      }
    }

    // CRUD & Data Fetching
    async function fetchPacientes(){ 
      const { data, error } = await supabase.from("pacientes").select("*").order("id",{ascending:false}); 
      return data||[]; 
    }
    async function fetchMedicos(){ 
      const { data, error } = await supabase.from("medicos").select("*").order("id",{ascending:false}); 
      return data||[]; 
    }

    function renderPacientes(list){ 
      const tbody=document.querySelector("#pacientes-table tbody"); 
      tbody.innerHTML=""; 
      list.forEach(p=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${p.nome} ${p.sobrenome}</td><td>${p.email}</td><td>${p.telefone}</td><td>${p.documento}</td><td>${p.numeroCarteira||"-"}</td><td>${p.planoMeses||"-"} meses</td><td><button data-id="${p.id}" class="edit-paciente">Editar</button> <button data-id="${p.id}" class="del-paciente danger">Excluir</button></td>`;
        tbody.appendChild(tr)
      }) 
    }

    function renderMedicos(list){ 
      const tbody=document.querySelector("#medicos-table tbody"); 
      tbody.innerHTML=""; 
      list.forEach(m=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${m.nome} ${m.sobrenome}</td><td>${m.email}</td><td>${m.telefone}</td><td>${m.documento}</td><td>${m.especialidade}</td><td><button data-id="${m.id}" class="edit-medico">Editar</button> <button data-id="${m.id}" class="del-medico danger">Excluir</button></td>`;
        tbody.appendChild(tr)
      }) 
    }

    function renderPlanoUnivitta(list){ 
      const tbody=document.querySelector("#plano-table tbody"); 
      if(!tbody) return; 
      tbody.innerHTML=""; 
      list.forEach(p=>{
        const dataAdesao = p.dataAdesaoPlano ? new Date(p.dataAdesaoPlano).toLocaleDateString("pt-BR") : "-";
        const diaVenc = p.dataAdesaoPlano ? new Date(p.dataAdesaoPlano).getDate() : "-";
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${p.nome} ${p.sobrenome}</td><td>${p.documento}</td><td>${dataAdesao}</td><td>${p.planoMeses||"-"} meses</td><td>${diaVenc}</td>`;
        tbody.appendChild(tr)
      }) 
    }

    async function initCadastros(){
      const [p, m] = await Promise.all([fetchPacientes(), fetchMedicos()]);
      renderPacientes(p);
      renderMedicos(m);
    }

    async function updateSelectors(){
      const [p, m] = await Promise.all([fetchPacientes(), fetchMedicos()]);
      const selP = document.getElementById("sel-paciente");
      const selM = document.getElementById("sel-medico");
      if(selP) selP.innerHTML = '<option value="">Selecione...</option>' + p.map(x=>`<option value="${x.id}">${x.nome} ${x.sobrenome}</option>`).join("");
      if(selM) selM.innerHTML = '<option value="">Selecione...</option>' + m.map(x=>`<option value="${x.id}">${x.nome} ${x.sobrenome}</option>`).join("");
    }

    // Dashboard
    async function loadDash(){
      const { data: { session } } = await supabase.auth.getSession();
      if(!session) return;
      const [pac, med, ag] = await Promise.all([
        supabase.from("pacientes").select("*",{count:"exact"}),
        supabase.from("medicos").select("*",{count:"exact"}),
        supabase.from("agendamentos").select("*").order("data",{ascending:true}).limit(5)
      ]);
      
      if(dashKpis){
        dashKpis.innerHTML = "";
        const items = [["Pacientes", pac.count], ["Médicos", med.count], ["Consultas", (ag.data||[]).length], ["Ativos", (pac.data||[]).filter(x=>x.planoMeses).length]];
        items.forEach(([t,v])=>{
          const c=document.createElement("div"); c.className="card"; c.innerHTML=`<div class="small">${t}</div><div style="font-size:24px;font-weight:bold;color:var(--primary)">${v||0}</div>`;
          dashKpis.appendChild(c);
        });
      }

      if(dashUpcomingBody){
        dashUpcomingBody.innerHTML = (ag.data||[]).map(a=>`<tr><td>${a.data}</td><td>${a.hora}</td><td>${a.especialidade}</td></tr>`).join("");
      }

      if(dashChart){
        const ctx=dashChart.getContext("2d");
        ctx.clearRect(0,0,dashChart.width,dashChart.height);
        const vals=[pac.count||0, med.count||0, (ag.data||[]).length, 10];
        const labels=["Pacientes","Médicos","Agendas","Meta"];
        const max=Math.max(...vals, 1); const w=60; const gap=40; const base=dashChart.height-30;
        vals.forEach((v,i)=>{
          const h=(v/max)*(dashChart.height-80); const x=50+i*(w+gap);
          const g=ctx.createLinearGradient(x, base-h, x, base); g.addColorStop(0, i%2?"#60a5fa":"#7dd3fc"); g.addColorStop(1, "transparent");
          ctx.fillStyle=g; ctx.fillRect(x, base-h, w, h);
          ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--text');
          ctx.font="11px Inter"; ctx.fillText(labels[i], x, base+15); ctx.fillText(String(v), x+w/2-5, base-h-10);
        });
      }
    }

    // Events
    document.querySelectorAll('[data-route], #link-cadastro').forEach(a=>a.addEventListener("click", e=>{
      e.preventDefault();
      const r = a.getAttribute("data-route") || a.getAttribute("href");
      routeTo(r);
    }));

    window.addEventListener("hashchange", renderRoute);
    
    // Auth Actions
    const loginForm = document.getElementById("login-form");
    if(loginForm) loginForm.addEventListener("submit", async e=>{
      e.preventDefault();
      const fd=new FormData(loginForm);
      const { error } = await supabase.auth.signInWithPassword({ email:fd.get("email"), password:fd.get("senha") });
      if(error) { toast(error.message); return; }
      await updateNav(); routeTo("#dashboard"); toast("Bem-vindo!");
    });

    const signupForm = document.getElementById("signup-form");
    if(signupForm) signupForm.addEventListener("submit", async e=>{
      e.preventDefault();
      const fd=new FormData(signupForm);
      const { error } = await supabase.auth.signUp({ email:fd.get("email"), password:fd.get("senha"), options:{ data:{ nome:fd.get("nome"), sobrenome:fd.get("sobrenome") } } });
      if(error) { toast(error.message); return; }
      toast("Cadastro solicitado! Verifique seu e-mail."); routeTo("#login");
    });

    if(logoutBtn) logoutBtn.addEventListener("click", async ()=>{ await supabase.auth.signOut(); updateNav(); routeTo("#login"); });

    // Forms
    pacienteForm.addEventListener("submit", async e=>{
      e.preventDefault();
      const fd=new FormData(pacienteForm);
      const id=fd.get("id");
      const body=Object.fromEntries(fd.entries());
      if(body.planoMeses) body.planoMeses = parseInt(body.planoMeses);
      const { error } = id ? await supabase.from("pacientes").update(body).eq("id",id) : await supabase.from("pacientes").insert([body]);
      if(error) toast(error.message); else { toast("Paciente salvo"); pacienteForm.reset(); initCadastros(); }
    });

    medicoForm.addEventListener("submit", async e=>{
      e.preventDefault();
      const fd=new FormData(medicoForm);
      const id=fd.get("id");
      const body=Object.fromEntries(fd.entries());
      const { error } = id ? await supabase.from("medicos").update(body).eq("id",id) : await supabase.from("medicos").insert([body]);
      if(error) toast(error.message); else { toast("Médico salvo"); medicoForm.reset(); initCadastros(); }
    });

    // Theme & Toast
    const toggleBtn = document.getElementById("theme-toggle")
    function setTheme(t){ document.documentElement.setAttribute("data-theme", t); localStorage.setItem("theme", t) }
    setTheme(localStorage.getItem("theme")||"dark")
    toggleBtn.addEventListener("click", ()=>{ const cur=document.documentElement.getAttribute("data-theme"); setTheme(cur==="dark"?"light":"dark") })
    function toast(t){ const d=document.createElement("div"); d.className="toast"; d.textContent=t; document.body.appendChild(d); setTimeout(()=>d.remove(), 3000) }

    // Init
    renderRoute();
    updateNav();

    // Calendar & Finance (Simplified versions of previously working code)
    const viewSel=document.getElementById("calendar-view"); const dateSel=document.getElementById("calendar-date");
    if(dateSel) dateSel.value = new Date().toISOString().slice(0,10);
    async function refreshCal(){ 
      const { data } = await supabase.from("agendamentos").select("*");
      const cal = document.getElementById("calendar");
      if(!cal) return;
      cal.innerHTML = '<div class="card">Carregando agenda...</div>';
      // Basic list view for now
      cal.innerHTML = (data||[]).map(a=>`<div class="card" style="margin-bottom:8px"><b>${a.data} ${a.hora}</b> - ${a.especialidade} (Sala ${a.sala||"1"})</div>`).join("");
    }
    const formAg=document.getElementById("agendamento-form");
    if(formAg) formAg.addEventListener("submit", async e=>{
      e.preventDefault();
      const fd=new FormData(formAg);
      const { error } = await supabase.from("agendamentos").insert([Object.fromEntries(fd.entries())]);
      if(error) toast(error.message); else { toast("Agendado!"); document.getElementById("modal").classList.add("hidden"); refreshCal(); }
    });
    document.getElementById("novo-agendamento")?.addEventListener("click", ()=>document.getElementById("modal").classList.remove("hidden"));
    document.getElementById("cancel-agendamento")?.addEventListener("click", ()=>document.getElementById("modal").classList.add("hidden"));

    async function loadPay(){ const { data } = await supabase.from("pagamentos").select("*").order("id",{ascending:false}); return data||[]; }
    function renderPay(list){ 
      const tb = document.querySelector("#pagamentos-table tbody");
      if(tb) tb.innerHTML = list.map(p=>`<tr><td>${p.consulta_id}</td><td>${p.convenio||"-"}</td><td>${p.procedimento}</td><td>R$ ${p.valor}</td><td>${new Date(p.criadoEm||Date.now()).toLocaleDateString()}</td></tr>`).join("");
    }
    document.getElementById("pagamento-form")?.addEventListener("submit", async e=>{
      e.preventDefault();
      const fd=new FormData(e.target);
      const { error } = await supabase.from("pagamentos").insert([{...Object.fromEntries(fd.entries()), criadoEm:new Date().toISOString()}]);
      if(error) toast(error.message); else { toast("Recebido!"); e.target.reset(); loadPay().then(renderPay); }
    });

    async function loadKPIs(){
      const [pac, med, pay] = await Promise.all([supabase.from("pacientes").select("*",{count:"exact"}), supabase.from("medicos").select("*",{count:"exact"}), supabase.from("pagamentos").select("valor")]);
      const total = (pay.data||[]).reduce((acc,v)=>acc+Number(v.valor),0);
      const box = document.getElementById("kpis-rel");
      if(box) box.innerHTML = `
        <div class="card"><div class="small">Total Pacientes</div><div style="font-size:24px">${pac.count}</div></div>
        <div class="card"><div class="small">Total Médicos</div><div style="font-size:24px">${med.count}</div></div>
        <div class="card"><div class="small">Receita Total</div><div style="font-size:24px;color:var(--success)">R$ ${total.toFixed(2)}</div></div>
      `;
    }
    document.getElementById("export-csv")?.addEventListener("click", async ()=>{
      const { data } = await supabase.from("pagamentos").select("*");
      const csv = "Data,Descrição,Valor\n" + data.map(r=>`${r.criadoEm},${r.procedimento},${r.valor}`).join("\n");
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href=url; a.download="relatorio.csv"; a.click();
    });

  </script>
</body>
</html>
